# Программа сравнения показателей по периодам

## Описание задачи

Программа предназначена для анализа и сравнения показателей по клиентским менеджерам и клиентам за два или три периода. Система загружает данные из Excel файлов, рассчитывает приросты показателей и формирует итоговые отчеты.

## Техническое задание

### Основные функции:
1. **Загрузка данных** из Excel файлов (2 или 3 файла)
2. **Расчет приростов** по формулам:
   - Для 2 периодов: `прирост = показатель_2 - показатель_1`
   - Для 3 периодов: `прирост = (показатель_3 - показатель_2) - (показатель_2 - показатель_1)`
3. **Формирование базы клиентов** из уникальных идентификаторов
4. **Создание сводок** по клиентам и менеджерам
5. **Экспорт результатов** в Excel файл

### Обрабатываемые поля:
- Табельный номер КМ
- Имя КМ (ФИО)
- ТБ (территориальный банк)
- ГОСБ (головной офис)
- Идентификатор клиента
- Наименование клиента
- Показатель (значение для анализа)

## Структура проекта

```
XLSX_TwoPeriod_compare_Prirpst/
├── main.py                    # Основная программа
├── config.py                  # Конфигурационные параметры
├── logger.py                  # Система логирования
├── test_data_generator.py     # Генератор тестовых данных
├── requirements.txt           # Зависимости проекта
├── .gitignore                 # Исключения для Git
├── README.md                # Документация
├── venv/                    # Виртуальное окружение
├── TZ.md                    # Техническое задание
├── IN_XLSX/                 # Входные Excel файлы
├── OUT_XLSX/                # Выходные Excel файлы
└── LOGS/                    # Файлы логов
```

## Установка и запуск

### 1. Создание виртуального окружения
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate    # Windows
```

### 2. Установка зависимостей
```bash
pip install pandas openpyxl
```

### 3. Создание тестовых данных
```bash
python test_data_generator.py
```

### 4. Запуск основной программы
```bash
python main.py
```

## Конфигурация

### Основные параметры (config.py):

#### LOG_CONFIG
- `level`: Уровень логирования ('INFO' или 'DEBUG')
- `file`: Имя файла лога
- `format`: Формат сообщений лога

#### ANALYSIS_CONFIG
- `file_count`: Количество файлов для анализа (2 или 3)
- `files`: Список конфигураций файлов (пути к файлам в каталоге IN_XLSX/)
- `output`: Настройки выходного файла
  - `file_name`: Имя выходного файла (сохраняется в каталоге OUT_XLSX/)
  - `sheets`: Названия листов
  - `columns`: Список колонок для каждого листа
  - `formatting`: Настройки форматирования колонок
    - `type`: Тип данных ('text', 'number' или 'text_padded')
    - `format`: Формат числа (например, '#,##0.00' для разделителей разрядов)
    - `pad_char`: Символ для дополнения (для типа 'text_padded')
    - `add_timestamp`: Добавлять временную метку к имени файла

#### Структура каталогов
- `IN_XLSX/`: Входные Excel файлы для анализа
- `OUT_XLSX/`: Выходные Excel файлы с результатами
- `LOGS/`: Файлы логов программы

#### TEST_DATA_CONFIG
- `clients_count`: Количество клиентов (25000)
- `managers_count`: Количество менеджеров (1000)
- `tb_count`: Количество ТБ (11)
- `gosb_per_tb`: Диапазон ГОСБ в каждом ТБ (5-10)
- `value_range`: Диапазон показателей (10000-1000000)
- `manager_change_rate`: Процент смены менеджеров (15%)
- `value_increase_rate`: Коэффициент увеличения показателей (1.2)

## Описание модулей

### main.py
Основная программа, содержащая класс `PeriodComparison`:

#### Методы:
- `load_excel_file()`: Загрузка данных из Excel файла
- `load_all_files()`: Загрузка всех файлов согласно конфигурации
- `create_clients_base()`: Создание базы клиентов
- `calculate_growth()`: Расчет приростов
- `create_managers_summary()`: Создание сводки по менеджерам
- `create_output_file()`: Создание выходного файла
- `run_analysis()`: Основной метод анализа

#### Пример использования:
```python
from main import PeriodComparison

# Создание экземпляра анализатора
analyzer = PeriodComparison()

# Запуск анализа
analyzer.run_analysis()
```

### config.py
Конфигурационный файл с параметрами:

#### LOG_MESSAGES
Словарь сообщений для логирования:
- `program_start`: 'Запуск программы сравнения периодов'
- `file_loading`: 'Загрузка файла: {}'
- `calculation_start`: 'Начало расчета приростов'
- `output_creation`: 'Создание выходного файла: {}'

#### ANALYSIS_CONFIG
Основные настройки анализа:
- `file_count`: Количество периодов
- `files`: Конфигурация файлов с колонками
- `output`: Настройки выходного файла

### logger.py
Система логирования с классом `Logger`:

#### Методы:
- `info()`: Информационные сообщения
- `debug()`: Отладочные сообщения
- `error()`: Сообщения об ошибках
- `log_file_loading()`: Логирование загрузки файлов
- `log_calculation_start()`: Логирование начала расчетов

#### Пример использования:
```python
from logger import logger

logger.info("Начало обработки")
logger.debug("Отладочная информация")
logger.error("Произошла ошибка")
```

### test_data_generator.py
Генератор тестовых данных с классом `TestDataGenerator`:

#### Методы:
- `generate_period_data()`: Генерация данных для периода
- `create_test_files()`: Создание тестовых Excel файлов
- `_generate_base_data()`: Генерация базовых данных

#### Пример использования:
```python
from test_data_generator import create_test_data

# Создание тестовых данных
success = create_test_data()
```

## Выходные данные

Программа создает Excel файл `comparison_result.xlsx` с двумя листами:

### Лист "Клиенты"
Содержит данные по каждому клиенту:
- Идентификатор клиента
- Наименование клиента
- Показатель 1, 2, 3 (по периодам)
- Прирост
- Табельный итоговый
- ФИО итогового сотрудника
- ГОСБ, ТБ

### Лист "Клиентские менеджеры"
Содержит сводку по менеджерам:
- Табельный уникальный
- ФИО
- ТБ, ГОСБ
- Показатели по периодам (суммы по клиентам)
- Суммарный прирост

## Логирование

Программа ведет подробные логи в файле `comparison.log`:

### Уровни логирования:
- **INFO**: Основные этапы выполнения
- **DEBUG**: Подробная информация о процессе

### Примеры сообщений:
```
2024-01-15 10:30:00 - INFO - Запуск программы сравнения периодов
2024-01-15 10:30:01 - INFO - Загрузка файла: test_data_period1.xlsx
2024-01-15 10:30:02 - DEBUG - Загружено 500 записей из файла test_data_period1.xlsx
2024-01-15 10:30:05 - INFO - Начало расчета приростов
2024-01-15 10:30:06 - INFO - Создание выходного файла: comparison_result.xlsx
```

## Версионный контроль

### Версия 1.3.0 (Текущая)
**Дата**: 23.10.2024

**Реализованные функции**:
- ✅ Создание виртуального окружения
- ✅ Система конфигурации
- ✅ Система логирования
- ✅ Основная программа анализа
- ✅ Генератор тестовых данных
- ✅ Документация
- ✅ Масштабирование до 25000 клиентов
- ✅ Форматирование колонок в выходном файле
- ✅ Форматирование с лидирующими нулями
- ✅ Временные метки в именах файлов

**Решенные проблемы**:
- Проблема с кодировкой русских символов в логах
- Ошибки при обработке пустых значений в Excel
- Проблемы с типами данных при расчете приростов
- Оптимизация производительности для больших объемов данных
- Улучшение читаемости выходных файлов
- Обработка строк с апострофами в данных

**Этапы разработки**:
1. **Настройка окружения**: Создание виртуального окружения и установка зависимостей
2. **Конфигурация**: Разработка системы конфигурационных параметров
3. **Логирование**: Реализация системы логирования с поддержкой уровней INFO и DEBUG
4. **Основная логика**: Разработка алгоритмов загрузки, обработки и расчета данных
5. **Тестирование**: Создание генератора тестовых данных
6. **Документация**: Написание подробной документации
7. **Масштабирование**: Увеличение объема тестовых данных до 25000 клиентов
8. **Форматирование**: Добавление форматирования колонок в выходном файле
9. **Расширенное форматирование**: Добавление лидирующих нулей и временных меток

**Технические особенности**:
- Использование pandas для работы с Excel файлами
- Поддержка как 2, так и 3 периодов анализа
- Автоматическое определение итогового менеджера по приоритету
- Гибкая система конфигурации колонок
- Подробное логирование всех операций
- Высокая производительность: обработка 25000 клиентов за ~3.8 секунды
- Профессиональное форматирование выходных файлов с разделителями разрядов
- Форматирование с лидирующими нулями для идентификаторов
- Автоматическое добавление временных меток к именам файлов

## Требования к системе

- Python 3.7+
- pandas >= 2.0.0
- openpyxl >= 3.0.0
- numpy (устанавливается автоматически с pandas)

## Возможные улучшения

1. **Валидация данных**: Добавление проверки корректности входных данных
2. **Графический интерфейс**: Создание GUI для удобства использования
3. **Поддержка других форматов**: Добавление поддержки CSV файлов
4. **Расширенная аналитика**: Добавление дополнительных метрик и графиков
5. **Автоматическое тестирование**: Добавление unit-тестов

## Поддержка

При возникновении проблем проверьте:
1. Корректность путей к файлам в конфигурации
2. Наличие всех необходимых колонок в Excel файлах
3. Логи программы в файле `comparison.log`
4. Соответствие форматов данных ожидаемым типам
