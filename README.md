# Программа сравнения показателей по периодам

## Описание задачи

Программа предназначена для анализа и сравнения показателей по клиентским менеджерам и клиентам за два или три периода. Система загружает данные из Excel файлов, рассчитывает приросты показателей и формирует итоговые отчеты.

## Техническое задание

### Основные функции:
1. **Загрузка данных** из Excel файлов (2 или 3 файла)
2. **Валидация и очистка данных** с заменой некорректных значений
3. **Правила агрегации данных** с 3 вариантами для клиентов и менеджеров
4. **Расчет приростов** по двум алгоритмам:
   - **По дате отчета**: стандартный расчет по итоговому менеджеру
   - **По дате сделки**: расчет по менеджеру, закрепленному в каждом периоде
5. **Формирование базы клиентов** из уникальных идентификаторов
6. **Обработка специальных зон** (серая зона 90000000, прочие данные 80000000)
7. **Создание сводок** по клиентам и менеджерам
8. **Экспорт результатов** в Excel файл с тремя листами
9. **4 режима работы** для различных сценариев использования

### Обрабатываемые поля:
- Табельный номер КМ
- Имя КМ (ФИО)
- ТБ (территориальный банк)
- ГОСБ (головной офис)
- Идентификатор клиента
- Наименование клиента
- Показатель (значение для анализа)

### Правила агрегации данных:

#### Для клиентов (client_aggregation_mode):
1. **По client_id** - агрегация только по идентификатору клиента
2. **По client_id + tb** - агрегация по идентификатору клиента и ТБ
3. **По client_id + tb + gosb** - агрегация по идентификатору клиента, ТБ и ГОСБ

#### Для менеджеров (manager_aggregation_mode):
1. **Все клиенты менеджера** - стандартная агрегация
2. **Клиенты с тем же ТБ** - только клиенты с одинаковым ТБ
3. **Клиенты с тем же ТБ и ГОСБ** - только клиенты с одинаковым ТБ и ГОСБ

### Специальные зоны:
- **Серая зона (90000000)**: 9XX00000 по ТБ, 9XXYYYYY по ТБ+ГОСБ
- **Прочие данные (80000000)**: 8XX00000 по ТБ, 8XXYYYYY по ТБ+ГОСБ

## Структура проекта

```
XLSX_TwoPeriod_compare_Prirpst/
├── main.py                    # Основная программа
├── config.py                  # Конфигурационные параметры
├── logger.py                  # Система логирования
├── test_data_generator.py     # Генератор тестовых данных
├── requirements.txt           # Зависимости проекта
├── .gitignore                 # Исключения для Git
├── README.md                # Документация
├── venv/                    # Виртуальное окружение
├── TZ.md                    # Техническое задание
├── IN_XLSX/                 # Входные Excel файлы
├── OUT_XLSX/                # Выходные Excel файлы
└── LOGS/                    # Файлы логов
```

## Режимы работы программы

Программа поддерживает 4 режима работы, которые настраиваются в `config.py`:

### Режим 1: Генерация тестовых данных
- **Назначение**: Создание тестовых файлов для разработки и тестирования
- **Файлы**: `test_period1.xlsx`, `test_period2.xlsx`, `test_period3.xlsx`
- **Использование**: Подготовка тестовых данных

### Режим 2: Анализ тестовых данных
- **Назначение**: Анализ существующих тестовых файлов
- **Файлы**: Использует `test_period1.xlsx`, `test_period2.xlsx`, `test_period3.xlsx`
- **Использование**: Тестирование алгоритмов на готовых данных

### Режим 3: Анализ обычных данных
- **Назначение**: Анализ основных файлов с реальными данными
- **Файлы**: Использует `QS ФОТ (30-06-2025).xlsx`, `QS ФОТ (31-05-2025).xlsx`, `QS ФОТ (30-04-2025).xlsx`
- **Использование**: Работа с реальными данными

### Режим 4: Генерация и анализ тестовых данных
- **Назначение**: Полный цикл: создание тестовых файлов и их анализ
- **Файлы**: Генерирует и анализирует тестовые файлы
- **Использование**: Полный цикл тестирования

## Логика расчета приростов

### Определение периодов:
- **T-0 (Текущий период)**: `QS ФОТ (30-06-2025).xlsx` - июнь 2025
- **T-1 (Прошлый период)**: `QS ФОТ (31-05-2025).xlsx` - май 2025
- **T-2 (Позапрошлый период)**: `QS ФОТ (30-04-2025).xlsx` - апрель 2025

### Формулы расчета:

#### При работе с 2 файлами:
```
Прирост = T-0 - T-1 = Июнь 2025 - Май 2025
```

#### При работе с 3 файлами:
```
Прирост = ((T-0) - (T-1)) - ((T-1) - (T-2))
        = ((Июнь - Май) - (Май - Апрель))
```

## Валидация и очистка данных

### Обработка табельных номеров:
- **Формат**: 8 знаков с лидирующими нулями (например: 00012345)
- **Серая зона** (`grey_zone`) → заменяется на `90000000`
- **Пустые значения, `-`, некорректные** → заменяются на `70000000`
- **Нормальные номера** остаются без изменений
- **Превышение 8 знаков** → заменяется на `70000000`
- **Апострофы** в номерах автоматически удаляются
- **Для табельных 70000000 и 90000000** в полях ТБ и ГОСБ устанавливается `-`

### Обработка показателей:
- **Формат Excel**: числовой с разделителями разрядов и 2 знака после запятой (`#,##0.00`)
- **Пустые значения** → заменяются на `0`
- **Некорректные значения** (`-`, нечисловые) → заменяются на `0`
- **Суммирование** всех показателей по каждому клиенту
- **Автоматическое форматирование** в выходных Excel файлах

### Новая логика валидации табельных номеров:

#### Формат табельных номеров:
- **Стандарт**: 8 знаков с лидирующими нулями (например: `00012345`)
- **Проверка длины**: Номера свыше 8 знаков заменяются на `70000000`
- **Автоматическое дополнение**: Короткие номера дополняются нулями слева

#### Логика замены некорректных значений:
1. **Серая зона** (`grey_zone`) → `90000000` (специальный случай)
2. **Пустые значения** (`""`, `None`) → `70000000` (новые случаи)
3. **Дефис** (`"-"`) → `70000000` (новые случаи)
4. **Некорректные значения** (нечисловые) → `70000000` (новые случаи)
5. **Нормальные номера** остаются без изменений

#### Обработка специальных табельных номеров:
- **70000000**: Новые случаи (пустые, некорректные) - ТБ и ГОСБ = "-"
- **90000000**: Серая зона - ТБ и ГОСБ = "-"
- **Оба номера НЕ исключаются** при выборе финального менеджера

### Логика исключения табельных номеров при выборе финального менеджера:

#### Исключаемые номера:
- **8XXYYYYY** - табельные номера, начинающиеся с 8 (8-значные)
- **9XXYYYYY** - табельные номера, начинающиеся с 9 (8-значные)
- **Исключение**: `70000000` и `90000000` остаются специальными случаями и НЕ исключаются

#### Алгоритм выбора финального менеджера:
1. **Приоритетный поиск**: Сначала ищет менеджеров с обычными табельными номерами
2. **Исключение**: Пропускает номера 8XXYYYYY и 9XXYYYYY при наличии альтернатив
3. **Fallback логика**: Если все менеджеры имеют исключенные номера, использует любого подходящего
4. **Гарантия**: Всегда найдется финальный менеджер, если есть хотя бы один

#### Примеры работы:
- **Клиент с менеджерами**: `12345678`, `81234567`, `91234567` → выберет `12345678`
- **Клиент с менеджерами**: `81234567`, `91234567` → выберет `81234567` (fallback)
- **Клиент с менеджером**: `70000000` или `90000000` → выберет соответствующий (специальные случаи)

### Форматирование Excel файлов:

#### Табельные номера:
- **Формат**: Текстовый с дополнением нулями (`text_padded`, 8 знаков)
- **Пример**: `00012345`, `70000000`, `90000000`
- **Автоматическое выравнивание** по правому краю

#### Показатели (значения):
- **Формат**: Числовой с разделителями разрядов (`#,##0.00`)
- **Пример**: `1,234.56`, `0.00`, `999,999.99`
- **Автоматическое выравнивание** по правому краю
- **Поддержка больших чисел** с разделителями тысяч

#### Текстовые поля:
- **ФИО менеджеров**: Обычный текст с выравниванием по левому краю
- **ТБ и ГОСБ**: Обычный текст с выравниванием по левому краю
- **Названия клиентов**: Обычный текст с выравниванием по левому краю

#### Автоматическое форматирование:
- **Автофильтр** на всех листах для удобной навигации
- **Закрепление заголовков** для прокрутки больших таблиц
- **Автоподбор ширины колонок** для оптимального отображения
- **Единый стиль шрифта** (Arial, 10pt) для всех ячеек

## Установка и запуск

### 1. Создание виртуального окружения
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate    # Windows
```

### 2. Установка зависимостей
```bash
pip install pandas openpyxl numpy
```

### 3. Настройка режима работы
В файле `config.py` установите нужный режим:
```python
PROGRAM_MODES = {
    'mode': 1,  # 1-4 варианта работы
}
```

### 4. Запуск программы
```bash
python main.py
```

## Конфигурация

### Основные параметры (config.py):

#### PROGRAM_MODES
- `mode`: Режим работы программы (1-4)

#### ANALYSIS_CONFIG
- `file_count`: Количество файлов для анализа (2 или 3)
- `files`: Список конфигураций файлов
- `output`: Настройки выходного файла
  - `file_name`: Имя выходного файла
  - `sheets`: Названия листов
  - `columns`: Список колонок для каждого листа
  - `formatting`: Настройки форматирования колонок

#### TEST_DATA_CONFIG
- `clients_count`: Количество клиентов (25000)
- `managers_count_min/max`: Диапазон количества менеджеров (1500-1600)
- `managers_per_gosb_min/max`: Диапазон менеджеров в ГОСБ (5-18)
- `value_range`: Диапазон показателей (10000-1000000)
- `manager_change_rate`: Процент смены менеджеров (15%)
- `value_increase_rate`: Коэффициент увеличения показателей (1.2)
- **Динамическая генерация имен файлов**: Имена тестовых файлов генерируются автоматически на основе обычных файлов с префиксом "test_"

## Динамическая генерация тестовых файлов

### Принцип работы:
1. **Анализ конфигурации**: Система анализирует файлы с `use_file=True` в `ANALYSIS_CONFIG['files']`
2. **Генерация имен**: Для каждого активного файла создается тестовое имя с префиксом `"test_"`
3. **Адаптивное количество**: Количество генерируемых файлов соответствует количеству активных файлов

### Примеры генерации:
```python
# Конфигурация файлов
'files': [
    {'path': 'QS ФОТ (30-06-2025).xlsx', 'use_file': True},
    {'path': 'QS ФОТ (31-05-2025).xlsx', 'use_file': True},
    {'path': 'QS ФОТ (30-04-2025).xlsx', 'use_file': False}
]

# Результат генерации
# test_QS ФОТ (30-06-2025).xlsx ✅
# test_QS ФОТ (31-05-2025).xlsx ✅
# Третий файл не создается (use_file=False)
```

### Преимущества:
- **🔄 Автоматизация**: Не нужно вручную обновлять список файлов
- **📝 Читаемость**: Имена тестовых файлов понятны и связаны с исходными
- **⚙️ Гибкость**: Легко управлять через параметр `use_file`
- **🧪 Консистентность**: Количество тестовых файлов всегда соответствует настройкам

## Описание модулей

### main.py
Основная программа, содержащая класс `PeriodComparison`:

#### Основные методы:
- `load_excel_file()`: Загрузка и валидация данных из Excel файла
- `load_all_files()`: Загрузка всех файлов согласно режиму работы
- `create_clients_base()`: Создание базы клиентов с суммированием показателей
- `calculate_growth()`: Расчет приростов по формулам
- `create_managers_summary()`: Создание сводки по менеджерам
- `create_managers_deal_date_summary()`: Создание сводки по дате сделки
- `create_output_file()`: Создание выходного файла с форматированием
- `run_analysis()`: Основной метод анализа с поддержкой 4 режимов

#### Методы валидации:
- `_validate_tab_number()`: Валидация табельных номеров (8 знаков, 70000000/90000000)
- `_validate_value()`: Валидация показателей (числовой формат, замена на 0)
- `_is_excluded_tab_number()`: Проверка исключенных табельных номеров (8XXYYYYY, 9XXYYYYY)

#### Методы режимов работы:
- `_generate_test_data_only()`: Режим 1 - генерация тестовых данных
- `_run_analysis_on_test_data()`: Режим 2 - анализ тестовых данных
- `_run_analysis_on_normal_data()`: Режим 3 - анализ обычных данных
- `_generate_and_analyze_test_data()`: Режим 4 - генерация и анализ

#### Методы форматирования:
- `_apply_formatting_to_file()`: Применение форматирования к Excel файлу
- `_apply_autofilter_and_freeze()`: Добавление автофильтра и закрепления строк

### config.py
Конфигурационный файл с параметрами:

#### PROGRAM_MODES
Настройки режимов работы:
- `mode`: Выбор режима работы (1-4)

#### ANALYSIS_CONFIG
Основные настройки анализа:
- `file_count`: Количество периодов
- `files`: Конфигурация основных файлов
- `output`: Настройки выходного файла

#### TEST_DATA_CONFIG
Настройки тестовых данных:
- `test_files`: Список имен тестовых файлов
- Параметры генерации данных

### logger.py
Система логирования с классом `Logger`:

#### Методы:
- `info()`: Информационные сообщения
- `debug()`: Отладочные сообщения
- `error()`: Сообщения об ошибках
- Специализированные методы логирования для каждого этапа

### test_data_generator.py
Генератор тестовых данных с классом `TestDataGenerator`:

#### Методы:
- `generate_period_data()`: Генерация данных для периода
- `create_test_files()`: Создание тестовых Excel файлов с динамическими именами
- `_generate_base_data()`: Генерация базовых данных
- **Динамическая генерация имен**: Имена файлов создаются на основе конфигурации с префиксом "test_"
- **Адаптивное количество файлов**: Количество генерируемых файлов зависит от параметра `use_file`

## Выходные данные

Программа создает Excel файл `comparison_result_YYYYMMDD_HHMM.xlsx` с тремя листами:

### Лист "Клиенты"
Содержит данные по каждому клиенту:
- **ID client**: Идентификатор клиента
- **Client Name**: Наименование клиента
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain**: Прирост
- **TN (final)**: Табельный итоговый
- **ФИО КМ (final)**: ФИО итогового сотрудника
- **ГОСБ**: Головной офис
- **ТБ**: Территориальный банк

### Лист "Клиентские менеджеры"
Содержит сводку по менеджерам с расчетом по итоговому менеджеру:
- **TN (unic)**: Табельный уникальный
- **ФИО**: ФИО менеджера
- **ТБ**: Территориальный банк
- **ГОСБ**: Головной офис
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain (total)**: Суммарный прирост

### Лист "КМ по дате сделки"
Содержит сводку по менеджерам с расчетом по менеджеру в каждом периоде:
- **TN (unic)**: Табельный уникальный
- **ФИО**: ФИО менеджера
- **ТБ**: Территориальный банк
- **ГОСБ**: Головной офис
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain (total)**: Суммарный прирост

## Форматирование выходных файлов

### Автоматические функции:
- **Автофильтр**: Включен на всех листах
- **Закрепление строк**: Первая строка с заголовками закреплена
- **Форматирование чисел**: Разделители разрядов для числовых значений
- **Лидирующие нули**: Для табельных номеров и идентификаторов клиентов

## Логирование

Программа ведет подробные логи в файле `comparison_YYYYMMDD_HHMM.log`:

### Уровни логирования:
- **INFO**: Основные этапы выполнения
- **DEBUG**: Подробная информация о процессе

### Примеры сообщений:
```
2024-10-23 15:30:00 - INFO - Запуск программы сравнения периодов
2024-10-23 15:30:01 - INFO - Режим 2: Анализ тестовых данных
2024-10-23 15:30:02 - DEBUG - Заменено 1875 некорректных табельных номеров на 90000000
2024-10-23 15:30:05 - INFO - База клиентов создана: 24375 записей
2024-10-23 15:30:06 - INFO - Приросты рассчитаны: 24375 записей
```

## Версионный контроль

### Версия 3.3.0 (Текущая)
**Дата**: 24.10.2025

**Новые функции**:
- ✅ **Динамическая генерация имен тестовых файлов** на основе обычных файлов с префиксом "test_"
- ✅ **Адаптивное количество файлов** в зависимости от параметра `use_file`
- ✅ **Удален параметр `test_files`** из конфигурации для упрощения
- ✅ **Автоматическое создание имен** типа `test_QS ФОТ (30-06-2025).xlsx`
- ✅ **Обновленные тесты** (56 тестов проходят успешно)

**Решенные проблемы**:
- Жестко заданные имена тестовых файлов
- Необходимость ручного обновления списка файлов
- Несоответствие количества файлов настройкам конфигурации
- Сложность управления тестовыми файлами

### Версия 3.2.0
**Дата**: 24.10.2025

**Новые функции**:
- ✅ **Улучшенная валидация табельных номеров** (8 знаков с лидирующими нулями)
- ✅ **Новая логика замены некорректных номеров** (70000000 для новых случаев)
- ✅ **Форматирование показателей** (разделители разрядов, 2 знака после запятой)
- ✅ **Автоматическое форматирование Excel** файлов
- ✅ **Обновленные тесты** (53 теста проходят успешно)

**Решенные проблемы**:
- Неправильный формат табельных номеров
- Отсутствие форматирования показателей в Excel
- Некорректная обработка пустых и некорректных значений
- Необходимость улучшения читаемости данных

### Версия 3.1.0
**Дата**: 24.10.2025

**Новые функции**:
- ✅ **Логика исключения табельных номеров** при выборе финального менеджера
- ✅ **Исключение номеров 8XXYYYYY и 9XXYYYYY** при наличии альтернатив
- ✅ **Fallback механизм** для случаев, когда все менеджеры исключены
- ✅ **Специальная обработка 90000000** (не исключается)
- ✅ **Тесты для новой логики** (36 тестов проходят успешно)

**Решенные проблемы**:
- Неправильный выбор финального менеджера с исключенными номерами
- Отсутствие приоритизации обычных табельных номеров
- Необходимость fallback логики для надежности

### Версия 3.0.0
**Дата**: 23.10.2025

**Новые функции**:
- ✅ 4 режима работы программы
- ✅ Валидация и очистка данных
- ✅ Обработка некорректных значений
- ✅ Автофильтр и закрепление строк
- ✅ Английские названия колонок
- ✅ Правильная хронология периодов
- ✅ Суммирование показателей по клиентам
- ✅ Обработка табельного номера 90000000
- ✅ **Правила агрегации данных** (3 варианта для клиентов и менеджеров)
- ✅ **Справочники кодов ТБ и ГОСБ** (12 банков, 100+ подразделений)
- ✅ **Обработка специальных зон** (серая зона 90000000, прочие данные 80000000)
- ✅ **Настройки полей** для поиска соответствий ТБ и ГОСБ
- ✅ **Пропорциональное распределение** в тестовых данных

**Решенные проблемы**:
- Ошибка с колонкой `value_period_3` при работе с 2 файлами
- Неправильный порядок файлов по периодам
- Отсутствие валидации данных
- Проблемы с суммированием показателей
- Отсутствие автофильтра в выходных файлах
- Отсутствие правил агрегации данных
- Необходимость обработки специальных зон
- Отсутствие справочников кодов ТБ и ГОСБ
- Проблемы с поиском соответствий ТБ и ГОСБ

**Этапы разработки**:
1. **Исправление ошибок**: Устранение проблем с колонками и формулами
2. **Валидация данных**: Добавление проверки и очистки данных
3. **Режимы работы**: Реализация 4 режимов работы программы
4. **Форматирование**: Добавление автофильтра и закрепления строк
5. **Оптимизация**: Улучшение логики суммирования и обработки данных
6. **Правила агрегации**: Реализация 3 вариантов агрегации для клиентов и менеджеров
7. **Справочники**: Добавление кодов ТБ и ГОСБ с полным списком банков
8. **Специальные зоны**: Обработка серой зоны и прочих данных
9. **Настройки полей**: Конфигурируемые поля для поиска соответствий
10. **Тестовые данные**: Пропорциональное распределение с реальными кодами

**Технические особенности**:
- Поддержка 4 режимов работы
- Валидация и очистка данных с заменой некорректных значений
- Правильная хронология периодов (T-0 > T-1 > T-2)
- Автофильтр и закрепление строк в выходных файлах
- Английские названия колонок для лучшей читаемости
- Суммирование всех показателей по каждому клиенту
- Обработка специального табельного номера 90000000
- **3 варианта правил агрегации** для клиентов и менеджеров
- **Справочники кодов ТБ и ГОСБ** с 12 банками и 100+ подразделениями
- **Обработка специальных зон** с кодами ТБ и ГОСБ
- **Настройки полей** для поиска соответствий с приоритетом
- **Пропорциональное распределение** в тестовых данных

## Требования к системе

- Python 3.7+
- pandas >= 2.0.0
- openpyxl >= 3.0.0
- numpy >= 1.20.0

## Возможные улучшения

1. **Расширенная валидация**: Добавление дополнительных проверок данных
2. **Графический интерфейс**: Создание GUI для выбора режима работы
3. **Поддержка других форматов**: Добавление поддержки CSV файлов
4. **Расширенная аналитика**: Добавление дополнительных метрик
5. **Автоматическое тестирование**: Добавление unit-тестов для всех режимов

## Поддержка

При возникновении проблем проверьте:
1. Корректность режима работы в `config.py`
2. Наличие всех необходимых файлов в каталоге `IN_XLSX/`
3. Логи программы в каталоге `LOGS/`
4. Соответствие форматов данных ожидаемым типам
5. Правильность настройки количества файлов (`file_count`)