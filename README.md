# Программа сравнения показателей по периодам

## Описание задачи

Программа предназначена для анализа и сравнения показателей по клиентским менеджерам и клиентам за два или три периода. Система загружает данные из Excel файлов, рассчитывает приросты показателей и формирует итоговые отчеты.

## Техническое задание

### Основные функции:
1. **Загрузка данных** из Excel файлов (2 или 3 файла)
2. **Валидация и очистка данных** с заменой некорректных значений
3. **Расчет приростов** по двум алгоритмам:
   - **По дате отчета**: стандартный расчет по итоговому менеджеру
   - **По дате сделки**: расчет по менеджеру, закрепленному в каждом периоде
4. **Формирование базы клиентов** из уникальных идентификаторов
5. **Создание сводок** по клиентам и менеджерам
6. **Экспорт результатов** в Excel файл с тремя листами
7. **4 режима работы** для различных сценариев использования

### Обрабатываемые поля:
- Табельный номер КМ
- Имя КМ (ФИО)
- ТБ (территориальный банк)
- ГОСБ (головной офис)
- Идентификатор клиента
- Наименование клиента
- Показатель (значение для анализа)

## Структура проекта

```
XLSX_TwoPeriod_compare_Prirpst/
├── main.py                    # Основная программа
├── config.py                  # Конфигурационные параметры
├── logger.py                  # Система логирования
├── test_data_generator.py     # Генератор тестовых данных
├── requirements.txt           # Зависимости проекта
├── .gitignore                 # Исключения для Git
├── README.md                # Документация
├── venv/                    # Виртуальное окружение
├── TZ.md                    # Техническое задание
├── IN_XLSX/                 # Входные Excel файлы
├── OUT_XLSX/                # Выходные Excel файлы
└── LOGS/                    # Файлы логов
```

## Режимы работы программы

Программа поддерживает 4 режима работы, которые настраиваются в `config.py`:

### Режим 1: Генерация тестовых данных
- **Назначение**: Создание тестовых файлов для разработки и тестирования
- **Файлы**: `test_period1.xlsx`, `test_period2.xlsx`, `test_period3.xlsx`
- **Использование**: Подготовка тестовых данных

### Режим 2: Анализ тестовых данных
- **Назначение**: Анализ существующих тестовых файлов
- **Файлы**: Использует `test_period1.xlsx`, `test_period2.xlsx`, `test_period3.xlsx`
- **Использование**: Тестирование алгоритмов на готовых данных

### Режим 3: Анализ обычных данных
- **Назначение**: Анализ основных файлов с реальными данными
- **Файлы**: Использует `QS ФОТ (30-06-2025).xlsx`, `QS ФОТ (31-05-2025).xlsx`, `QS ФОТ (30-04-2025).xlsx`
- **Использование**: Работа с реальными данными

### Режим 4: Генерация и анализ тестовых данных
- **Назначение**: Полный цикл: создание тестовых файлов и их анализ
- **Файлы**: Генерирует и анализирует тестовые файлы
- **Использование**: Полный цикл тестирования

## Логика расчета приростов

### Определение периодов:
- **T-0 (Текущий период)**: `QS ФОТ (30-06-2025).xlsx` - июнь 2025
- **T-1 (Прошлый период)**: `QS ФОТ (31-05-2025).xlsx` - май 2025
- **T-2 (Позапрошлый период)**: `QS ФОТ (30-04-2025).xlsx` - апрель 2025

### Формулы расчета:

#### При работе с 2 файлами:
```
Прирост = T-0 - T-1 = Июнь 2025 - Май 2025
```

#### При работе с 3 файлами:
```
Прирост = ((T-0) - (T-1)) - ((T-1) - (T-2))
        = ((Июнь - Май) - (Май - Апрель))
```

## Валидация и очистка данных

### Обработка табельных номеров:
- **Некорректные значения** (`grey_zone`, `-`, пустые) → заменяются на `90000000`
- **Для табельного 90000000** в полях ТБ и ГОСБ устанавливается `-`
- **Апострофы** в номерах автоматически удаляются

### Обработка показателей:
- **Пустые значения** → заменяются на `0`
- **Некорректные значения** (`-`, нечисловые) → заменяются на `0`
- **Суммирование** всех показателей по каждому клиенту

## Установка и запуск

### 1. Создание виртуального окружения
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate    # Windows
```

### 2. Установка зависимостей
```bash
pip install pandas openpyxl numpy
```

### 3. Настройка режима работы
В файле `config.py` установите нужный режим:
```python
PROGRAM_MODES = {
    'mode': 1,  # 1-4 варианта работы
}
```

### 4. Запуск программы
```bash
python main.py
```

## Конфигурация

### Основные параметры (config.py):

#### PROGRAM_MODES
- `mode`: Режим работы программы (1-4)

#### ANALYSIS_CONFIG
- `file_count`: Количество файлов для анализа (2 или 3)
- `files`: Список конфигураций файлов
- `output`: Настройки выходного файла
  - `file_name`: Имя выходного файла
  - `sheets`: Названия листов
  - `columns`: Список колонок для каждого листа
  - `formatting`: Настройки форматирования колонок

#### TEST_DATA_CONFIG
- `test_files`: Названия тестовых файлов
- `clients_count`: Количество клиентов (25000)
- `managers_count`: Количество менеджеров (1000)
- `tb_count`: Количество ТБ (11)
- `gosb_per_tb`: Диапазон ГОСБ в каждом ТБ (5-10)
- `value_range`: Диапазон показателей (10000-1000000)
- `manager_change_rate`: Процент смены менеджеров (15%)
- `value_increase_rate`: Коэффициент увеличения показателей (1.2)

## Описание модулей

### main.py
Основная программа, содержащая класс `PeriodComparison`:

#### Основные методы:
- `load_excel_file()`: Загрузка и валидация данных из Excel файла
- `load_all_files()`: Загрузка всех файлов согласно режиму работы
- `create_clients_base()`: Создание базы клиентов с суммированием показателей
- `calculate_growth()`: Расчет приростов по формулам
- `create_managers_summary()`: Создание сводки по менеджерам
- `create_managers_deal_date_summary()`: Создание сводки по дате сделки
- `create_output_file()`: Создание выходного файла с форматированием
- `run_analysis()`: Основной метод анализа с поддержкой 4 режимов

#### Методы валидации:
- `_validate_tab_number()`: Валидация табельных номеров
- `_validate_value()`: Валидация показателей

#### Методы режимов работы:
- `_generate_test_data_only()`: Режим 1 - генерация тестовых данных
- `_run_analysis_on_test_data()`: Режим 2 - анализ тестовых данных
- `_run_analysis_on_normal_data()`: Режим 3 - анализ обычных данных
- `_generate_and_analyze_test_data()`: Режим 4 - генерация и анализ

#### Методы форматирования:
- `_apply_formatting_to_file()`: Применение форматирования к Excel файлу
- `_apply_autofilter_and_freeze()`: Добавление автофильтра и закрепления строк

### config.py
Конфигурационный файл с параметрами:

#### PROGRAM_MODES
Настройки режимов работы:
- `mode`: Выбор режима работы (1-4)

#### ANALYSIS_CONFIG
Основные настройки анализа:
- `file_count`: Количество периодов
- `files`: Конфигурация основных файлов
- `output`: Настройки выходного файла

#### TEST_DATA_CONFIG
Настройки тестовых данных:
- `test_files`: Список имен тестовых файлов
- Параметры генерации данных

### logger.py
Система логирования с классом `Logger`:

#### Методы:
- `info()`: Информационные сообщения
- `debug()`: Отладочные сообщения
- `error()`: Сообщения об ошибках
- Специализированные методы логирования для каждого этапа

### test_data_generator.py
Генератор тестовых данных с классом `TestDataGenerator`:

#### Методы:
- `generate_period_data()`: Генерация данных для периода
- `create_test_files()`: Создание тестовых Excel файлов
- `_generate_base_data()`: Генерация базовых данных

## Выходные данные

Программа создает Excel файл `comparison_result_YYYYMMDD_HHMM.xlsx` с тремя листами:

### Лист "Клиенты"
Содержит данные по каждому клиенту:
- **ID client**: Идентификатор клиента
- **Client Name**: Наименование клиента
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain**: Прирост
- **TN (final)**: Табельный итоговый
- **ФИО КМ (final)**: ФИО итогового сотрудника
- **ГОСБ**: Головной офис
- **ТБ**: Территориальный банк

### Лист "Клиентские менеджеры"
Содержит сводку по менеджерам с расчетом по итоговому менеджеру:
- **TN (unic)**: Табельный уникальный
- **ФИО**: ФИО менеджера
- **ТБ**: Территориальный банк
- **ГОСБ**: Головной офис
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain (total)**: Суммарный прирост

### Лист "КМ по дате сделки"
Содержит сводку по менеджерам с расчетом по менеджеру в каждом периоде:
- **TN (unic)**: Табельный уникальный
- **ФИО**: ФИО менеджера
- **ТБ**: Территориальный банк
- **ГОСБ**: Головной офис
- **val (T-0)**: Показатель текущего периода
- **val (T-1)**: Показатель прошлого периода
- **val (T-2)**: Показатель позапрошлого периода (при 3 файлах)
- **Gain (total)**: Суммарный прирост

## Форматирование выходных файлов

### Автоматические функции:
- **Автофильтр**: Включен на всех листах
- **Закрепление строк**: Первая строка с заголовками закреплена
- **Форматирование чисел**: Разделители разрядов для числовых значений
- **Лидирующие нули**: Для табельных номеров и идентификаторов клиентов

## Логирование

Программа ведет подробные логи в файле `comparison_YYYYMMDD_HHMM.log`:

### Уровни логирования:
- **INFO**: Основные этапы выполнения
- **DEBUG**: Подробная информация о процессе

### Примеры сообщений:
```
2024-10-23 15:30:00 - INFO - Запуск программы сравнения периодов
2024-10-23 15:30:01 - INFO - Режим 2: Анализ тестовых данных
2024-10-23 15:30:02 - DEBUG - Заменено 1875 некорректных табельных номеров на 90000000
2024-10-23 15:30:05 - INFO - База клиентов создана: 24375 записей
2024-10-23 15:30:06 - INFO - Приросты рассчитаны: 24375 записей
```

## Версионный контроль

### Версия 2.0.0 (Текущая)
**Дата**: 23.10.2025

**Новые функции**:
- ✅ 4 режима работы программы
- ✅ Валидация и очистка данных
- ✅ Обработка некорректных значений
- ✅ Автофильтр и закрепление строк
- ✅ Английские названия колонок
- ✅ Правильная хронология периодов
- ✅ Суммирование показателей по клиентам
- ✅ Обработка табельного номера 90000000

**Решенные проблемы**:
- Ошибка с колонкой `value_period_3` при работе с 2 файлами
- Неправильный порядок файлов по периодам
- Отсутствие валидации данных
- Проблемы с суммированием показателей
- Отсутствие автофильтра в выходных файлах

**Этапы разработки**:
1. **Исправление ошибок**: Устранение проблем с колонками и формулами
2. **Валидация данных**: Добавление проверки и очистки данных
3. **Режимы работы**: Реализация 4 режимов работы программы
4. **Форматирование**: Добавление автофильтра и закрепления строк
5. **Оптимизация**: Улучшение логики суммирования и обработки данных

**Технические особенности**:
- Поддержка 4 режимов работы
- Валидация и очистка данных с заменой некорректных значений
- Правильная хронология периодов (T-0 > T-1 > T-2)
- Автофильтр и закрепление строк в выходных файлах
- Английские названия колонок для лучшей читаемости
- Суммирование всех показателей по каждому клиенту
- Обработка специального табельного номера 90000000

## Требования к системе

- Python 3.7+
- pandas >= 2.0.0
- openpyxl >= 3.0.0
- numpy >= 1.20.0

## Возможные улучшения

1. **Расширенная валидация**: Добавление дополнительных проверок данных
2. **Графический интерфейс**: Создание GUI для выбора режима работы
3. **Поддержка других форматов**: Добавление поддержки CSV файлов
4. **Расширенная аналитика**: Добавление дополнительных метрик
5. **Автоматическое тестирование**: Добавление unit-тестов для всех режимов

## Поддержка

При возникновении проблем проверьте:
1. Корректность режима работы в `config.py`
2. Наличие всех необходимых файлов в каталоге `IN_XLSX/`
3. Логи программы в каталоге `LOGS/`
4. Соответствие форматов данных ожидаемым типам
5. Правильность настройки количества файлов (`file_count`)